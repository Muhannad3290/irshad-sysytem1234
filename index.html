<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRSHAD SYSTEM | Registry v8.3 (Sort Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
        }
        
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .table-container::-webkit-scrollbar { height: 6px; }
        .table-container::-webkit-scrollbar-track { background: transparent; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .status-btn:active { transform: scale(0.95); }
        .login-wrapper { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 8px #3b82f6;
            animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        input, select, textarea { font-size: 16px !important; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            main { padding: 0; margin: 0; }
        }
    </style>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
</head>
<body class="bg-[#F8FAFC] text-[#1E293B]">
    
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0RmXR2hpyvS2ANEdAGjYGVFadumrMGV8",
            authDomain: "irshad-main-a2b8e.firebaseapp.com",
            projectId: "irshad-main-a2b8e",
            storageBucket: "irshad-main-a2b8e.firebasestorage.app",
            messagingSenderId: "344322410207",
            appId: "1:344322410207:web:987e26cd7b33b808108b6a",
            measurementId: "G-S8BKPJR977"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.fs = { collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, onSnapshot, setDoc, query, orderBy, writeBatch };
        window.fa = { signInWithEmailAndPassword, signOut, onAuthStateChanged };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const SYSTEM_FIELDS = [
            { key: 'serialNo', label: 'Serial No' },
            { key: 'reference', label: 'Reference' },
            { key: 'institution', label: 'Institution' },
            { key: 'caseType', label: 'Case Type' },
            { key: 'remark', label: 'Remark' },
            { key: 'buyerName', label: 'Buyer Name' },
            { key: 'buyerId', label: 'Buyer ID' },
            { key: 'buyerEmail', label: 'Buyer Email' },
            { key: 'buyerPhone', label: 'Buyer Phone' },
            { key: 'sellerName', label: 'Seller Name' },
            { key: 'sellerId', label: 'Seller ID' },
            { key: 'sellerEmail', label: 'Seller Email' },
            { key: 'sellerPhone', label: 'Seller Phone' },
            { key: 'status', label: 'Current Status' },
            { key: 'processor', label: 'Processor' },
            { key: 'dateReceived', label: 'Date Received' },
            { key: 'dateHandover', label: 'Date Handover' }
        ];

        const Icon = React.memo(({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        root: iconRef.current.parentNode,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        });

        const StatusBadge = React.memo(({ status }) => { 
            const colors = { 'Pending': 'bg-amber-50 text-amber-600 border-amber-100', 'Delivered': 'bg-emerald-50 text-emerald-600 border-emerald-100', 'Under Process': 'bg-blue-50 text-blue-600 border-blue-100' }; 
            return (<span className={`px-4 py-2 rounded-xl text-[11px] font-black uppercase border flex items-center gap-2 whitespace-nowrap ${colors[status] || 'bg-slate-100 text-slate-500'}`}><div className={`w-1.5 h-1.5 rounded-full ${status === 'Delivered' ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : status === 'Pending' ? 'bg-amber-500' : 'bg-blue-500 animate-pulse'}`}></div>{status}</span>); 
        });

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    await window.fa.signInWithEmailAndPassword(window.auth, email, password);
                } catch (err) {
                    setError("Login Failed: " + err.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen login-wrapper flex items-center justify-center p-6">
                    <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl p-10 text-center animate-in zoom-in duration-500">
                        <div className="w-20 h-20 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg rotate-3">
                            <Icon name="shield-check" size={40} />
                        </div>
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight mb-2">IRSHAD SYSTEM</h1>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-8">Secure Access Required</p>
                        <form onSubmit={handleLogin} className="space-y-4 text-left">
                            <div>
                                <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Login ID</label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="user" size={18} /></div>
                                    <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-4 pl-12 bg-slate-50 rounded-2xl font-bold text-slate-800 border-none outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Enter ID" required/>
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Password</label>
                                <div className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="lock" size={18} /></div>
                                    <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 pl-12 bg-slate-50 rounded-2xl font-bold text-slate-800 border-none outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="••••••" required/>
                                </div>
                            </div>
                            {error && <div className="p-3 bg-red-50 text-red-500 text-xs font-black rounded-xl text-center flex items-center justify-center gap-2"><Icon name="alert-circle" size={14}/>{error}</div>}
                            <button disabled={loading} type="submit" className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase shadow-xl hover:bg-black transition-all flex items-center justify-center gap-2">
                                {loading ? 'Verifying...' : 'Access System'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [cases, setCases] = useState([]);
            const [trash, setTrash] = useState([]);
            const [bankList, setBankList] = useState(['ADCB', 'Mashreq Bank', 'CBD', 'NBF', 'Ajman Bank', 'Dubai Islamic Bank']);
            const [statusList, setStatusList] = useState(['Pending', 'Under Process', 'Processed', 'Delivered']);
            const [customHeadings, setCustomHeadings] = useState([]);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedCase, setSelectedCase] = useState(null);
            
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showStatusModal, setShowStatusModal] = useState(false);
            
            const [importProgress, setImportProgress] = useState(null);
            const [reportFilters, setReportFilters] = useState({ bank: '', status: [], startDate: '', endDate: '' });
            const [isEditing, setIsEditing] = useState(false);
            const [search, setSearch] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [visibleCount, setVisibleCount] = useState(20);

            const [statusTarget, setStatusTarget] = useState(null);
            const [updaterName, setUpdaterName] = useState(''); 
            const [selectedNewStatus, setSelectedNewStatus] = useState(null);

            const [isScanning, setIsScanning] = useState(false);
            const [scanStatus, setScanStatus] = useState('');
            const [isCameraActive, setIsCameraActive] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const emptyForm = {
                serialNo: '', reference: '', institution: '', caseType: 'Sale', remark: '',
                buyerName: '', buyerId: '', buyerEmail: '', buyerPhone: '',
                sellerName: '', sellerId: '', sellerEmail: '', sellerPhone: '',
                status: 'Pending', processor: '', dateReceived: '', dateHandover: '',
                photo: null, customData: {}
            };
            const [formData, setFormData] = useState(emptyForm);

            // HELPER: CORRECTLY PARSE DATE STRINGS FOR SORTING
            const parseDateHelper = (dStr) => {
                if (!dStr) return 0;
                // Try converting DD/MM/YYYY or similar to timestamp
                // Assume DD/MM/YYYY hh:mm:ss format
                const clean = dStr.split(',')[0].trim(); 
                if (clean.includes('/')) {
                    const parts = clean.split('/');
                    // Month is 0-indexed in JS Date
                    if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]).getTime();
                } 
                else if (clean.includes('-')) {
                    const parts = clean.split('-');
                    if(parts[0].length === 4) return new Date(clean).getTime(); // YYYY-MM-DD
                    if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]).getTime();
                }
                return new Date(dStr).getTime() || 0;
            };

            useEffect(() => {
                if (window.auth) setFirebaseReady(true);
                else window.addEventListener('firebase-ready', () => setFirebaseReady(true));
            }, []);

            useEffect(() => {
                if (firebaseReady) {
                    const unsub = window.fa.onAuthStateChanged(window.auth, (u) => setUser(u));
                    return () => unsub();
                }
            }, [firebaseReady]);

            useEffect(() => {
                if (!user || !firebaseReady) return;
                
                // We remove orderBy("timestamp", "desc") because string sorting is broken for DD/MM dates.
                // We will sort manually in the snap callback.
                const qCases = window.fs.query(window.fs.collection(window.db, "cases"));
                
                const unsubCases = window.fs.onSnapshot(qCases, 
                    (snap) => {
                        const rawData = snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        // MANUAL SORT: Sort by timestamp DESC using correct date parsing
                        rawData.sort((a, b) => parseDateHelper(b.timestamp) - parseDateHelper(a.timestamp));
                        setCases(rawData);
                    },
                    (err) => { console.error("Snapshot Error:", err); }
                );

                const qTrash = window.fs.query(window.fs.collection(window.db, "trash"), window.fs.orderBy("deletedAt", "desc"));
                const unsubTrash = window.fs.onSnapshot(qTrash, (snap) => setTrash(snap.docs.map(doc => ({ ...doc.data(), id: doc.id }))));

                const unsubSettings = window.fs.onSnapshot(window.fs.doc(window.db, "settings", "global"), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if(data.banks) setBankList(data.banks);
                        if(data.statuses) setStatusList(data.statuses);
                        if(data.headings) setCustomHeadings(data.headings);
                    }
                });
                return () => { unsubCases(); unsubTrash(); unsubSettings(); };
            }, [user, firebaseReady]);

            const confirmStatusUpdate = async () => {
                if (!statusTarget || !selectedNewStatus) return;
                if (!updaterName.trim()) return alert("Please enter who is performing this update."); 
                const now = new Date();
                const timestamp = now.toLocaleString('en-GB'); 
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const todayDate = `${day}/${month}/${year}`;
                try {
                    let updateData = { 
                        status: selectedNewStatus, 
                        statusTimestamp: timestamp,
                        lastUpdatedBy: updaterName 
                    };
                    if (selectedNewStatus === 'Pending') updateData.dateReceived = todayDate;
                    else if (selectedNewStatus === 'Delivered') updateData.dateHandover = todayDate;
                    
                    await window.fs.updateDoc(window.fs.doc(window.db, "cases", statusTarget.id), updateData);
                    if (selectedCase && selectedCase.id === statusTarget.id) setSelectedCase({ ...selectedCase, ...updateData });
                    setShowStatusModal(false); setStatusTarget(null); setSelectedNewStatus(null);
                } catch (err) { alert("Error updating status: " + err.message); }
            };

            const openStatusModal = (item) => { setStatusTarget(item); setUpdaterName(user.email || ''); setSelectedNewStatus(null); setShowStatusModal(true); };
            
            const handleSave = async (e) => {
                e.preventDefault();
                const now = new Date();
                const timestamp = now.toLocaleString('en-GB');
                
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const todayDate = `${day}/${month}/${year}`;

                try {
                    let dataToSubmit = { ...formData };

                    // Auto-fill dates if missing
                    if (dataToSubmit.status === 'Pending' && !dataToSubmit.dateReceived) {
                        dataToSubmit.dateReceived = todayDate;
                    }
                    if (dataToSubmit.status === 'Delivered' && !dataToSubmit.dateHandover) {
                        dataToSubmit.dateHandover = todayDate;
                    }

                    if (isEditing) {
                        const { id, ...dataToSave } = dataToSubmit;
                        await window.fs.updateDoc(window.fs.doc(window.db, "cases", id), dataToSave);
                    } else {
                        const { id, ...newEntry } = dataToSubmit; 
                        await window.fs.addDoc(window.fs.collection(window.db, "cases"), { 
                            ...newEntry, 
                            timestamp, // System creation time
                            statusTimestamp: timestamp 
                        });
                    }
                    closeModal();
                } catch (error) { alert("Error saving record: " + error.message); }
            };

            const softDelete = async (id) => {
                if(confirm("Move this record to Recycle Bin?")) {
                    const item = cases.find(c => c.id === id);
                    if(!item) return;
                    const { id: oldId, ...data } = item;
                    await window.fs.addDoc(window.fs.collection(window.db, "trash"), { ...data, deletedAt: new Date().toLocaleString() });
                    await window.fs.deleteDoc(window.fs.doc(window.db, "cases", id));
                    if(currentView === 'details') setCurrentView('dashboard');
                }
            };

            const restoreItem = async (id) => {
                const itemToRestore = trash.find(c => c.id === id);
                if(itemToRestore) {
                    const { id: oldId, deletedAt, ...data } = itemToRestore;
                    await window.fs.addDoc(window.fs.collection(window.db, "cases"), data);
                    await window.fs.deleteDoc(window.fs.doc(window.db, "trash", id));
                }
            };

            const permanentDelete = async (id) => { if(confirm("Permanent delete? Cannot be undone.")) await window.fs.deleteDoc(window.fs.doc(window.db, "trash", id)); };

            const resetSystem = async () => {
                if(confirm("CRITICAL: Delete ALL cloud records from the system?")) {
                    if(confirm("FINAL WARNING: This action is permanent and cannot be undone. Do you wish to proceed?")) {
                        try {
                            const snapshot = await window.fs.getDocs(window.fs.collection(window.db, "cases"));
                            const total = snapshot.docs.length;
                            if (total === 0) return alert("System is already empty.");
                            setImportProgress(0);
                            const chunkSize = 400;
                            const docs = snapshot.docs;
                            for (let i = 0; i < total; i += chunkSize) {
                                const batch = window.fs.writeBatch(window.db);
                                const chunk = docs.slice(i, i + chunkSize);
                                chunk.forEach(d => batch.delete(d.ref));
                                await batch.commit();
                                setImportProgress(Math.min(100, Math.round(((i + chunk.length) / total) * 100)));
                            }
                            alert("System Reset Complete. All cloud records have been wiped.");
                            setImportProgress(null);
                        } catch (err) { alert("Reset failed. Please check your connection."); setImportProgress(null); }
                    }
                }
            };

            const updateSettings = async (type, newList) => {
                const settingDoc = window.fs.doc(window.db, "settings", "global");
                await window.fs.setDoc(settingDoc, { [type]: newList }, { merge: true });
            };

            const handleBulkImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = window.XLSX.read(bstr, { type: 'binary' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const dataRows = window.XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });
                        const total = dataRows.length;
                        const now = new Date().toLocaleString('en-GB');
                        
                        setImportProgress(0);
                        const settingsSnap = await window.fs.getDoc(window.fs.doc(window.db, "settings", "global"));
                        const currentSettings = settingsSnap.exists() ? settingsSnap.data() : {};
                        const currentBanks = new Set(currentSettings.banks || bankList);
                        const currentStatuses = new Set(currentSettings.statuses || statusList);
                        const currentHeadings = new Set(currentSettings.headings || customHeadings);

                        dataRows.forEach(row => {
                            const inst = row['Institution'] || row['institution'];
                            if (inst && typeof inst === 'string' && inst.trim() !== '') currentBanks.add(inst.trim());
                            const st = row['Current Status'] || row['status'];
                            if (st && typeof st === 'string' && st.trim() !== '') currentStatuses.add(st.trim());
                            Object.keys(row).forEach(key => {
                                const cleanKey = key.trim();
                                if (!cleanKey || cleanKey.startsWith('__EMPTY')) return;
                                const isSystem = SYSTEM_FIELDS.some(sf => sf.key.toLowerCase() === cleanKey.toLowerCase() || sf.label.toLowerCase() === cleanKey.toLowerCase());
                                const isStatusField = ['status', 'current status'].includes(cleanKey.toLowerCase());
                                const isDateLogic = ['timestamp', 'date', 'created at', 'date created', 'date received', 'date handover'].includes(cleanKey.toLowerCase());
                                if (!isSystem && !isStatusField && !isDateLogic) currentHeadings.add(cleanKey);
                            });
                        });

                        const updatedBanks = Array.from(currentBanks);
                        const updatedStatuses = Array.from(currentStatuses);
                        const updatedHeadings = Array.from(currentHeadings);
                        await window.fs.setDoc(window.fs.doc(window.db, "settings", "global"), { banks: updatedBanks, statuses: updatedStatuses, headings: updatedHeadings }, { merge: true });
                        setBankList(updatedBanks); setStatusList(updatedStatuses); setCustomHeadings(updatedHeadings);

                        const chunkSize = 400; 
                        for (let i = 0; i < total; i += chunkSize) {
                            const chunk = dataRows.slice(i, i + chunkSize);
                            const batch = window.fs.writeBatch(window.db);
                            chunk.forEach(row => {
                                const newCaseRef = window.fs.doc(window.fs.collection(window.db, "cases"));
                                let rowTimestamp = now;
                                
                                const genericDateKeys = Object.keys(row).filter(k => ['timestamp', 'date', 'created at'].includes(k.toLowerCase()));
                                if (genericDateKeys.length > 0 && row[genericDateKeys[0]]) {
                                    rowTimestamp = String(row[genericDateKeys[0]]);
                                } 
                                else {
                                    const receivedKey = Object.keys(row).find(k => k.toLowerCase().includes('received'));
                                    if (receivedKey && row[receivedKey]) rowTimestamp = String(row[receivedKey]);
                                    else {
                                        const handoverKey = Object.keys(row).find(k => k.toLowerCase().includes('handover'));
                                        if (handoverKey && row[handoverKey]) rowTimestamp = String(row[handoverKey]);
                                    }
                                }

                                const entry = { ...emptyForm, timestamp: rowTimestamp, statusTimestamp: rowTimestamp };
                                
                                SYSTEM_FIELDS.forEach(field => {
                                    const matchingKey = Object.keys(row).find(k => k.trim().toLowerCase() === field.label.toLowerCase() || k.trim().toLowerCase() === field.key.toLowerCase());
                                    if (matchingKey && row[matchingKey]) entry[field.key] = String(row[matchingKey]);
                                });

                                const statusKey = Object.keys(row).find(k => ['current status', 'status'].includes(k.trim().toLowerCase()));
                                if (statusKey && row[statusKey]) entry.status = row[statusKey];

                                // Ensure imported excel dates stick
                                if (entry.status === 'Pending' && !entry.dateReceived) entry.dateReceived = rowTimestamp;
                                if (entry.status === 'Delivered' && !entry.dateHandover) entry.dateHandover = rowTimestamp;

                                entry.customData = {};
                                Object.keys(row).forEach(key => {
                                    const cleanKey = key.trim();
                                    if (!cleanKey || cleanKey.startsWith('__EMPTY')) return;
                                    const isSystem = SYSTEM_FIELDS.some(sf => sf.key.toLowerCase() === cleanKey.toLowerCase() || sf.label.toLowerCase() === cleanKey.toLowerCase());
                                    const isStatusField = ['status', 'current status'].includes(cleanKey.toLowerCase());
                                    const isDateLogic = ['timestamp', 'date', 'created at', 'date received', 'date handover'].includes(cleanKey.toLowerCase());
                                    if (!isSystem && !isStatusField && !isDateLogic) entry.customData[cleanKey] = String(row[key]);
                                });
                                batch.set(newCaseRef, entry);
                            });
                            await batch.commit();
                            setImportProgress(Math.min(100, Math.round(((i + chunk.length) / total) * 100)));
                        }
                        alert(`Successfully imported ${total} records.`);
                        setImportProgress(null); setShowImportModal(false);
                    } catch (err) { console.error(err); alert("Import Failed. Check console."); setImportProgress(null); }
                };
                reader.readAsBinaryString(file);
            };

            const generateSpecificReport = (type) => {
                const { bank, status, startDate, endDate } = reportFilters;
                
                const parseDate = (dStr) => {
                    if (!dStr) return null;
                    const clean = dStr.split(',')[0].trim(); 
                    if (clean.includes('/')) {
                        const parts = clean.split('/');
                        return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    } else if (clean.includes('-')) {
                        const parts = clean.split('-');
                        if(parts[0].length === 4) return new Date(clean); 
                        return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    }
                    return new Date(clean);
                };

                const targetData = cases.filter(c => {
                    const matchBank = bank ? (c.institution || "").trim() === bank.trim() : true;
                    const matchStatus = status.length > 0 ? status.some(s => (c.status || "").trim().toLowerCase() === s.trim().toLowerCase()) : true;
                    let matchDate = true;
                    if (startDate || endDate) {
                        try {
                            let dateStrToCheck = c.timestamp; 
                            if (status.includes('Pending')) dateStrToCheck = c.dateReceived;
                            else if (status.includes('Delivered')) dateStrToCheck = c.dateHandover;

                            const caseDate = parseDate(dateStrToCheck);
                            if (caseDate && !isNaN(caseDate)) {
                                if (startDate) matchDate = matchDate && caseDate >= new Date(startDate);
                                if (endDate) matchDate = matchDate && caseDate <= new Date(endDate);
                            } else { matchDate = false; }
                        } catch (e) { console.error("Date error", e); matchDate = false; }
                    }
                    return matchBank && matchStatus && matchDate;
                });

                if (targetData.length === 0) return alert("No records found matching your filters.");

                if (type === 'excel') {
                    const excelData = targetData.map(c => {
                        const row = {};
                        SYSTEM_FIELDS.forEach(f => row[f.label] = c[f.key] || "-");
                        customHeadings.forEach(h => row[h] = (c.customData && c.customData[h]) || "-");
                        return row;
                    });
                    const ws = window.XLSX.utils.json_to_sheet(excelData);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, "Report");
                    window.XLSX.writeFile(wb, `Report_${bank || 'All'}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    doc.setFontSize(18); 
                    if (reportFilters.status.includes('Delivered')) doc.text("OFFICIAL DELIVERY REPORT", 14, 20);
                    else doc.text("OFFICIAL STATUS REPORT", 14, 20);
                    doc.setFontSize(10); 
                    let subText = `Generated on: ${new Date().toLocaleString()}`;
                    if (startDate || endDate) subText += ` | Range: ${startDate || 'Start'} to ${endDate || 'Now'}`;
                    doc.text(subText, 14, 27);
                    const header = [["SI", "Ref", "Inst", "Buyer", "Seller", "Status", "Date Ref"]];
                    const body = targetData.map(c => {
                        let displayDate = c.timestamp;
                        if(status.includes('Pending')) displayDate = c.dateReceived;
                        if(status.includes('Delivered')) displayDate = c.dateHandover;
                        return [c.serialNo, c.reference, c.institution, c.buyerName, c.sellerName, c.status, displayDate || '-'];
                    });
                    doc.autoTable({ head: header, body, startY: 35, theme: 'grid' });
                    if (reportFilters.status.includes('Delivered')) {
                        let finalY = doc.lastAutoTable.finalY + 25;
                        if (finalY > 170) { doc.addPage(); finalY = 40; }
                        doc.setFontSize(10); doc.setFont("helvetica", "bold");
                        doc.text("Prepared By:", 30, finalY); doc.line(30, finalY + 15, 90, finalY + 15); 
                        doc.text("Delivered By:", 120, finalY); doc.line(120, finalY + 15, 180, finalY + 15); 
                        doc.text("Received By:", 210, finalY); doc.line(210, finalY + 15, 270, finalY + 15); 
                        doc.setFont("helvetica", "normal"); doc.setFontSize(8);
                        doc.text("(Signature & Date)", 30, finalY + 20); doc.text("(Signature & Date)", 120, finalY + 20); doc.text("(Signature & Date)", 210, finalY + 20);
                    }
                    doc.save("Report.pdf");
                }
                setShowReportModal(false);
            };

            const exportVaultPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                const header = [["SI", "Ref", "Inst", "Buyer", "Seller", "Status", "Received"]];
                const body = filteredData.map(c => [c.serialNo, c.reference, c.institution, c.buyerName, c.sellerName, c.status, c.dateReceived]);
                doc.setFontSize(16); doc.text("IRSHAD SYSTEM - RECORDS REGISTRY", 14, 15);
                doc.autoTable({ head: header, body, startY: 22, theme: 'grid' });
                doc.save("Vault_Registry.pdf");
            };

            const filteredData = useMemo(() => {
                let data = cases.filter(c => {
                    const s = search.toLowerCase();
                    const matchesSearch = (c.institution || "").toLowerCase().includes(s) || (c.serialNo || "").toLowerCase().includes(s) || (c.reference || "").toLowerCase().includes(s) || (c.buyerName || "").toLowerCase().includes(s) || (c.sellerName || "").toLowerCase().includes(s);
                    let matchesDate = true;
                    if (startDate || endDate) {
                        try {
                            let dateStrToCheck = c.timestamp; 
                            if (c.status === 'Pending' && c.dateReceived) dateStrToCheck = c.dateReceived;
                            else if (c.status === 'Delivered' && c.dateHandover) dateStrToCheck = c.dateHandover;

                            const caseDate = parseDateHelper(dateStrToCheck);
                            // Parse helper returns ms timestamp, convert back to date for compare
                            const checkTime = new Date(caseDate).setHours(0,0,0,0);
                            
                            if (startDate) {
                                const start = new Date(startDate).setHours(0,0,0,0);
                                if (checkTime < start) matchesDate = false;
                            }
                            if (endDate) {
                                const end = new Date(endDate).setHours(0,0,0,0);
                                if (checkTime > end) matchesDate = false;
                            }
                        } catch(e) { matchesDate = false; }
                    }
                    return matchesSearch && matchesDate;
                });

                // ==========================================
                // FIX: SORT VAULT BY DATE (DESCENDING)
                // ==========================================
                return data.sort((a, b) => {
                    let dateA = a.timestamp;
                    if (a.status === 'Pending' && a.dateReceived) dateA = a.dateReceived;
                    else if (a.status === 'Delivered' && a.dateHandover) dateA = a.dateHandover;

                    let dateB = b.timestamp;
                    if (b.status === 'Pending' && b.dateReceived) dateB = b.dateReceived;
                    else if (b.status === 'Delivered' && b.dateHandover) dateB = b.dateHandover;

                    return parseDateHelper(dateB) - parseDateHelper(dateA);
                });

            }, [cases, search, startDate, endDate]);

            const openNewEntry = () => { setIsEditing(false); setFormData(emptyForm); setShowModal(true); };
            const openModify = (c) => { setIsEditing(true); setFormData(c); setShowModal(true); };
            const closeModal = () => { 
                setShowModal(false); setIsEditing(false); setIsCameraActive(false); 
                if(videoRef.current && videoRef.current.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop());
            };
            const openCamera = async () => { 
                setIsCameraActive(true); 
                try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); if (videoRef.current) videoRef.current.srcObject = stream; } 
                catch (err) { alert("Unable to access camera."); setIsCameraActive(false); } 
            };
            const snap = () => { 
                const canvas = canvasRef.current; const video = videoRef.current;
                const scale = 800 / video.videoWidth; canvas.width = 800; canvas.height = video.videoHeight * scale; 
                const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, 800, canvas.height); 
                const compressedImage = canvas.toDataURL('image/jpeg', 0.6);
                setFormData({ ...formData, photo: compressedImage }); video.srcObject.getTracks().forEach(t => t.stop()); setIsCameraActive(false); performOCR(compressedImage);
            };
            const performOCR = (image) => {
                if(!window.Tesseract) return; setIsScanning(true); setScanStatus('Reading Cheque/Document...');
                Tesseract.recognize(image, 'eng', { logger: m => setScanStatus(`Scanning: ${Math.round(m.progress * 100)}%`) }).then(({ data: { text } }) => {
                    setFormData(prev => ({ ...prev, remark: (prev.remark + " [SCANNED: " + text.replace(/\n/g, " ").trim() + "]").trim() })); setScanStatus(''); setIsScanning(false);
                }).catch(err => { console.error(err); setScanStatus('Scan failed'); setTimeout(() => setIsScanning(false), 2000); });
            };
            const toggleReportStatus = (s) => {
                const current = [...reportFilters.status];
                const idx = current.indexOf(s);
                if (idx > -1) current.splice(idx, 1); else current.push(s);
                setReportFilters({...reportFilters, status: current});
            };

            if (!firebaseReady) return <div className="h-screen flex items-center justify-center font-black text-slate-300 bg-slate-900 tracking-widest animate-pulse uppercase">SYSTEM INITIALIZING...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="min-h-screen flex relative bg-[#F8FAFC]">
                    <div className="md:hidden fixed top-0 left-0 right-0 bg-white border-b z-[60] p-4 flex justify-between items-center shadow-sm">
                        <div className="font-black text-slate-800 flex items-center gap-2"><div className="bg-blue-600 p-1.5 rounded-lg text-white"><Icon name="cpu" size={16} /></div>IRSHAD SYSTEM</div>
                        <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="p-2 bg-slate-100 rounded-lg text-slate-600"><Icon name="menu" size={24} /></button>
                    </div>
                    {isSidebarOpen && (<div className="fixed inset-0 bg-slate-900/50 z-[70] md:hidden backdrop-blur-sm" onClick={() => setSidebarOpen(false)}></div>)}
                    <aside className={`no-print w-72 bg-white border-r flex flex-col p-6 h-screen fixed md:sticky top-0 z-[80] transition-transform duration-300 ease-in-out sidebar-transition ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:top-0 shadow-2xl md:shadow-none`}>
                        <div className="flex justify-between items-center mb-10 px-2">
                            <div className="flex items-center gap-3 font-black text-xl text-slate-800"><div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><Icon name="cpu" /></div><span>IRSHAD <span className="text-blue-600">SYSTEM</span></span></div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden p-2 text-slate-400 hover:text-slate-600"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="space-y-1 overflow-y-auto no-scrollbar max-h-[50vh]">
                            <SidebarLink active={currentView === 'dashboard'} onClick={() => {setCurrentView('dashboard'); setVisibleCount(20); setSidebarOpen(false);}} icon="layout" label="Dashboard" />
                            <SidebarLink active={currentView === 'list'} onClick={() => {setCurrentView('list'); setVisibleCount(20); setSidebarOpen(false);}} icon="database" label="Records Vault" />
                            <SidebarLink active={currentView === 'trash'} onClick={() => {setCurrentView('trash'); setSidebarOpen(false);}} icon="trash-2" label="Recycle Bin" />
                            <SidebarLink active={showSettings} onClick={() => { setShowSettings(true); setSidebarOpen(false); }} icon="settings" label="Categories" />
                        </div>
                        <div className="mt-auto pt-4 border-t space-y-2">
                            <button onClick={() => { setShowImportModal(true); setSidebarOpen(false); }} className="w-full py-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-black flex items-center justify-center gap-2 hover:bg-slate-200 transition-all tracking-wider"><Icon name="upload-cloud" size={16}/> Bulk Import</button>
                            <button onClick={() => { setShowReportModal(true); setSidebarOpen(false); }} className="w-full py-3 bg-indigo-600 text-white rounded-xl text-xs font-black flex items-center justify-center gap-2 shadow-md hover:bg-indigo-700 transition-all tracking-wider"><Icon name="file-text" size={16}/> Specific Report</button>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => generateSpecificReport('excel')} className="py-2.5 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-emerald-700 transition-all flex items-center justify-center gap-1"><Icon name="file-spreadsheet" size={12}/> Excel</button>
                                <button onClick={exportVaultPDF} className="py-2.5 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-slate-900 transition-all flex items-center justify-center gap-1"><Icon name="printer" size={12}/> PDF</button>
                            </div>
                            <button onClick={() => { openNewEntry(); setSidebarOpen(false); }} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-xl mt-2 flex items-center justify-center gap-2 hover:bg-blue-700 transition-all tracking-wider"><Icon name="plus" /> New Entry</button>
                            <div className="flex flex-col gap-1 pt-2">
                                <button onClick={resetSystem} className="w-full py-2 bg-red-50 text-red-500 rounded-xl text-[9px] font-black uppercase border border-red-100 hover:bg-red-500 hover:text-white transition-all tracking-widest flex items-center justify-center gap-2"><Icon name="refresh-ccw" size={12}/> Reset System</button>
                                <button onClick={() => { if(confirm("CRITICAL: Logout?")) window.fa.signOut(window.auth); }} className="w-full py-3 bg-slate-50 text-slate-400 rounded-xl text-xs font-black flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-600 transition-all tracking-wider"><Icon name="log-out" size={16}/> Logout</button>
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 p-4 pt-20 md:p-10 pb-24 overflow-x-hidden w-full">
                        {currentView === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm w-full max-w-xs mx-auto md:mx-0">
                                    <h2 className="font-bold text-slate-800 text-xs mb-3 uppercase tracking-tight flex items-center gap-2"><div className="text-blue-600"><Icon name="pie-chart" size={14} /></div> Analytics</h2>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left border-separate border-spacing-0">
                                            <thead><tr className="text-[9px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100"><th className="pb-2 pl-2 border-b">Status</th><th className="pb-2 text-right pr-2 border-b">Count</th></tr></thead>
                                            <tbody className="divide-y divide-slate-50">
                                                <tr className="group hover:bg-slate-50 transition-colors"><td className="py-2 pl-2 font-black text-slate-800 flex items-center gap-2 text-[10px]"><div className="p-1 bg-slate-100 rounded text-slate-600"><Icon name="layers" size={10} /></div>TOTAL</td><td className="py-2 text-right pr-2 font-black text-xs text-slate-900">{cases.length}</td></tr>
                                                {statusList.map(st => (<tr key={st} className="group hover:bg-slate-50 transition-colors"><td className="py-2 pl-2 font-bold text-slate-600 flex items-center gap-2 text-[10px]"><div className={`w-5 h-5 rounded flex items-center justify-center ${st === 'Delivered' ? 'bg-emerald-100 text-emerald-600' : st === 'Pending' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'}`}><Icon name="activity" size={10} /></div>{st}</td><td className="py-2 text-right pr-2 font-bold text-xs text-slate-700">{cases.filter(c => c.status === st).length}</td></tr>))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[2.5rem] p-6 md:p-10 border shadow-md overflow-hidden">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                                            <div><h2 className="font-black text-slate-800 text-xl md:text-2xl uppercase tracking-tighter">Recent Activities</h2><p className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Live Updates from Cloud Storage</p></div>
                                            <button onClick={() => setCurrentView('list')} className="text-[10px] font-black text-blue-600 uppercase tracking-widest hover:underline flex items-center gap-2">Explore Full Vault <Icon name="chevron-right" size={14}/></button>
                                    </div>
                                    <div className="table-container overflow-x-auto">
                                            <table className="w-full text-left min-w-[900px] border-separate border-spacing-0">
                                                <thead>
                                                    <tr className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                                        <th className="pb-6 pl-4 pr-6 border-b border-slate-100">SI NO</th>
                                                        <th className="pb-6 pr-6 border-b border-slate-100">Reference</th>
                                                        <th className="pb-6 pr-6 border-b border-slate-100">Institution</th>
                                                        <th className="pb-6 pr-6 border-b border-slate-100">Party Details</th>
                                                        <th className="pb-6 pr-6 border-b border-slate-100">Status</th>
                                                        <th className="pb-6 text-right pr-4 border-b border-slate-100">Manage</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {cases.slice(0, 10).map(c => {
                                                        // SMART DATE LOGIC FOR DASHBOARD TABLE
                                                        let displayDate = c.timestamp;
                                                        let dateLabel = "Updated";
                                                        if (c.status === 'Pending' && c.dateReceived) { displayDate = c.dateReceived; dateLabel = "Received"; }
                                                        else if (c.status === 'Delivered' && c.dateHandover) { displayDate = c.dateHandover; dateLabel = "Handover"; }

                                                        return (
                                                            <tr key={c.id} className="group hover:bg-slate-50/80 transition-all cursor-default">
                                                                <td className="py-6 pl-4 pr-6"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black text-[10px] shadow-lg group-hover:scale-110 transition-transform">#{c.serialNo}</div></div></td>
                                                                <td className="py-6 pr-6 font-bold text-slate-500 text-xs">{c.reference || "-"}</td>
                                                                <td className="py-6 pr-6"><div className="flex flex-col"><span className="font-black text-slate-800 text-sm tracking-tight">{c.institution || "-"}</span><span className="text-[9px] font-black text-blue-500 uppercase mt-0.5">{c.caseType}</span></div></td>
                                                                <td className="py-6 pr-6"><div className="flex flex-col gap-1"><div className="flex items-center gap-2"><span className="w-10 text-[8px] font-black text-slate-300 uppercase">Buyer</span><span className="text-[11px] font-bold text-slate-700 uppercase truncate max-w-[140px]">{c.buyerName || "—"}</span></div><div className="flex items-center gap-2 border-t border-slate-50 pt-1"><span className="w-10 text-[8px] font-black text-slate-300 uppercase">Seller</span><span className="text-[11px] font-bold text-slate-600 uppercase truncate max-w-[140px]">{c.sellerName || "—"}</span></div></div></td>
                                                                <td className="py-6 pr-6"><div className="flex flex-col"><button onClick={() => openStatusModal(c)} className="status-btn self-start"><StatusBadge status={c.status} /></button><span className="text-[8px] font-bold text-slate-400 mt-1.5 ml-1">{displayDate}</span></div></td>
                                                                <td className="py-6 text-right pr-4"><div className="flex items-center justify-end gap-1"><button onClick={() => { setSelectedCase(c); setCurrentView('details'); }} className="p-2.5 bg-white border border-slate-100 text-slate-400 hover:text-blue-600 hover:border-blue-200 hover:shadow-sm rounded-xl transition-all"><Icon name="eye" size={16}/></button><button onClick={() => openModify(c)} className="p-2.5 bg-white border border-slate-100 text-slate-400 hover:text-amber-500 hover:border-amber-200 hover:shadow-sm rounded-xl transition-all"><Icon name="edit-3" size={16}/></button><button onClick={() => softDelete(c.id)} className="p-2.5 bg-white border border-slate-100 text-slate-400 hover:text-red-500 hover:border-red-200 hover:shadow-sm rounded-xl transition-all"><Icon name="trash-2" size={16}/></button></div></td>
                                                            </tr>
                                                        );
                                                    })}
                                                    {cases.length === 0 && (<tr><td colSpan="6" className="py-20 text-center text-slate-300 font-black uppercase tracking-[0.2em] text-xs">No records found in the vault</td></tr>)}
                                                </tbody>
                                            </table>
                                    </div>
                                </div>
                            </div>
                        )}
                        {currentView === 'list' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-[2rem] border shadow-sm">
                                    <div className="relative mb-4"><div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="search" size={18} /></div><input type="text" placeholder="Search Vault..." className="w-full p-4 pl-12 bg-slate-50 border-none rounded-2xl outline-none shadow-inner" value={search} onChange={e => {setSearch(e.target.value); setVisibleCount(20);}} /></div>
                                    <div className="flex flex-wrap gap-4">
                                        <div className="flex-1 min-w-[150px]"><label className="text-[9px] font-black text-slate-400 uppercase ml-1">From Date</label><input type="date" className="w-full p-3 bg-slate-50 rounded-xl border-none text-xs font-bold shadow-inner" value={startDate} onChange={e => {setStartDate(e.target.value); setVisibleCount(20);}} /></div>
                                        <div className="flex-1 min-w-[150px]"><label className="text-[9px] font-black text-slate-400 uppercase ml-1">To Date</label><input type="date" className="w-full p-3 bg-slate-50 rounded-xl border-none text-xs font-bold shadow-inner" value={endDate} onChange={e => {setEndDate(e.target.value); setVisibleCount(20);}} /></div>
                                    </div>
                                </div>
                                <div className="grid gap-4">
                                    {filteredData.slice(0, visibleCount).map(c => {
                                        // Display which date we are showing for clarity
                                        let displayDate = c.timestamp;
                                        let dateLabel = "Updated";
                                        if (c.status === 'Pending' && c.dateReceived) { displayDate = c.dateReceived; dateLabel = "Received"; }
                                        else if (c.status === 'Delivered' && c.dateHandover) { displayDate = c.dateHandover; dateLabel = "Handover"; }

                                        return (
                                            <div key={c.id} className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex items-center justify-between gap-4 group hover:border-blue-200 transition-all animate-in slide-in-from-bottom-2 duration-300">
                                                <div className="flex items-center gap-5 w-full">
                                                    <div className="w-12 h-12 bg-slate-900 rounded-xl flex items-center justify-center font-black text-white text-xs shrink-0">#{c.serialNo}</div>
                                                    <div className="overflow-hidden w-full">
                                                        <h3 className="font-bold text-slate-800 truncate">{c.institution} ({c.reference})</h3>
                                                        <p className="text-[10px] text-slate-400 font-bold uppercase truncate">{c.buyerName} vs {c.sellerName}</p>
                                                        <p className="text-[9px] text-blue-500 font-bold mt-1 uppercase tracking-wider">{dateLabel}: {displayDate}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 w-auto justify-end">
                                                    <button onClick={() => openStatusModal(c)} className="status-btn"><StatusBadge status={c.status} /></button>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => { setSelectedCase(c); setCurrentView('details'); }} className="p-3 bg-slate-50 text-slate-400 hover:text-blue-600 rounded-xl transition-all"><Icon name="eye" size={18} /></button>
                                                        <button onClick={() => openModify(c)} className="p-3 bg-slate-50 text-slate-400 hover:text-amber-500 rounded-xl transition-all"><Icon name="edit-3" size={18} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                {filteredData.length > visibleCount && (<button onClick={() => setVisibleCount(prev => prev + 20)} className="w-full py-4 bg-white border border-slate-200 rounded-2xl font-black text-slate-400 uppercase text-xs hover:bg-slate-50 transition-all tracking-widest shadow-sm">Load More Records ({filteredData.length - visibleCount} Remaining)</button>)}
                            </div>
                        )}
                        {currentView === 'details' && selectedCase && (
                            <div className="max-w-4xl mx-auto pb-10">
                                <div className="mb-4 flex justify-between items-center">
                                    <button onClick={() => setCurrentView('dashboard')} className="flex items-center gap-2 text-slate-400 font-bold text-[10px] uppercase hover:text-blue-600 transition-all"><Icon name="arrow-left" size={12} /> Return</button>
                                    <div className="flex gap-2">
                                        <button onClick={() => openModify(selectedCase)} className="bg-amber-50 text-amber-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-amber-100 transition-all shadow-sm"><div className="inline mr-1"><Icon name="edit-3" size={12} /></div> Edit</button>
                                        <button onClick={() => softDelete(selectedCase.id)} className="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-red-100 transition-all shadow-sm"><div className="inline mr-1"><Icon name="trash-2" size={12} /></div> Delete</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border">
                                    <div className="bg-slate-900 p-8 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><h2 className="text-4xl font-black tracking-tighter mb-2">Case #{selectedCase.serialNo}</h2><p className="text-slate-400 text-xs font-bold uppercase tracking-widest">{selectedCase.timestamp}</p></div><button onClick={() => openStatusModal(selectedCase)} className="status-btn"><StatusBadge status={selectedCase.status} /></button></div>
                                    <div className="p-8 bg-[#F8FAFC]">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {SYSTEM_FIELDS.map(f => <DetailCard key={f.key} label={f.label} value={selectedCase[f.key]} icon="info" />)}
                                            {Array.from(new Set([...customHeadings, ...Object.keys(selectedCase.customData || {})])).map(h => (<DetailCard key={h} label={h} value={(selectedCase.customData && selectedCase.customData[h])} icon="plus-circle" />))}
                                            {selectedCase.lastUpdatedBy && (<DetailCard label="Last Updated By" value={selectedCase.lastUpdatedBy} icon="user-check" />)}
                                            {selectedCase.statusTimestamp && (<DetailCard label="Last Update Time" value={selectedCase.statusTimestamp} icon="clock" />)}
                                        </div>
                                        {selectedCase.photo && <div className="mt-8"><p className="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">Attachment</p><img src={selectedCase.photo} className="w-full rounded-3xl border shadow-lg" /></div>}
                                    </div>
                                </div>
                            </div>
                        )}
                        {currentView === 'trash' && (
                             <div className="space-y-6">
                                <div className="bg-white p-6 rounded-[2rem] border flex justify-between items-center"><div><h2 className="text-xl font-black uppercase tracking-tight">Recycle Bin</h2><p className="text-xs text-slate-400 font-bold uppercase tracking-widest">Recently Deleted</p></div></div>
                                <div className="grid gap-4">
                                    {trash.map(c => (
                                        <div key={c.id} className="bg-white p-6 rounded-[2.5rem] border flex flex-col md:flex-row items-center justify-between opacity-75 hover:opacity-100 transition-all shadow-sm gap-4">
                                            <div className="flex items-center gap-5 w-full">
                                                <div className="w-12 h-12 bg-red-50 text-red-400 rounded-xl flex items-center justify-center font-black text-xs">DEL</div>
                                                <div><h3 className="font-bold">{c.institution} (#{c.serialNo})</h3><p className="text-[10px] text-slate-400">Deleted: {c.deletedAt}</p></div>
                                            </div>
                                            <div className="flex items-center gap-2 w-full md:w-auto justify-end">
                                                <button onClick={() => restoreItem(c.id)} className="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl text-[10px] font-black uppercase hover:bg-emerald-100 transition-all shadow-sm"><div className="inline mr-1"><Icon name="rotate-ccw" size={12} /></div> Restore</button>
                                                <button onClick={() => permanentDelete(c.id)} className="px-4 py-2 bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase hover:bg-red-100 transition-all shadow-sm">Forever</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                    {showModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-md overflow-y-auto">
                            <div className="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden my-auto max-h-[90vh] overflow-y-auto no-scrollbar">
                                <div className="p-8 border-b flex justify-between items-center sticky top-0 bg-white z-10 shadow-sm"><h3 className="font-black text-slate-800 text-xl uppercase tracking-tighter">{isEditing ? 'Modify Entry' : 'New Entry'}</h3><button onClick={closeModal} className="p-2 hover:bg-slate-100 rounded-full transition-all"><Icon name="x" className="text-slate-400"/></button></div>
                                <form onSubmit={handleSave} className="p-8 space-y-6">
                                    <div className="space-y-4">
                                        <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Case Information</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <Input label="Serial No" value={formData.serialNo} onChange={v => setFormData({...formData, serialNo: v})} required />
                                            <Input label="Reference" value={formData.reference} onChange={v => setFormData({...formData, reference: v})} required />
                                            <Select label="Institution" value={formData.institution} options={bankList} onChange={v => setFormData({...formData, institution: v})} />
                                            <Select label="Case Type" value={formData.caseType} options={['Sale', 'Mortgage', 'Gift', 'Evaluation']} onChange={v => setFormData({...formData, caseType: v})} />
                                            <Input label="Remark" value={formData.remark} onChange={v => setFormData({...formData, remark: v})} />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Buyer Details</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <Input label="Name" value={formData.buyerName} onChange={v => setFormData({...formData, buyerName: v})} />
                                            <Input label="ID Number" value={formData.buyerId} onChange={v => setFormData({...formData, buyerId: v})} />
                                            <Input label="Email" type="email" value={formData.buyerEmail} onChange={v => setFormData({...formData, buyerEmail: v})} />
                                            <Input label="Phone" type="tel" value={formData.buyerPhone} onChange={v => setFormData({...formData, buyerPhone: v})} />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Seller Details</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <Input label="Name" value={formData.sellerName} onChange={v => setFormData({...formData, sellerName: v})} />
                                            <Input label="ID Number" value={formData.sellerId} onChange={v => setFormData({...formData, sellerId: v})} />
                                            <Input label="Email" type="email" value={formData.sellerEmail} onChange={v => setFormData({...formData, sellerEmail: v})} />
                                            <Input label="Phone" type="tel" value={formData.sellerPhone} onChange={v => setFormData({...formData, sellerPhone: v})} />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Processing Details</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <Select label="Current Status" value={formData.status} options={statusList} onChange={v => setFormData({...formData, status: v})} />
                                            <Input label="Processor Note" value={formData.processor} onChange={v => setFormData({...formData, processor: v})} />
                                            <Input label="Date Received" value={formData.dateReceived} onChange={v => setFormData({...formData, dateReceived: v})} placeholder="DD/MM/YYYY" />
                                            <Input label="Date Handover" value={formData.dateHandover} onChange={v => setFormData({...formData, dateHandover: v})} placeholder="DD/MM/YYYY" />
                                        </div>
                                    </div>
                                    {Array.from(new Set([...customHeadings, ...Object.keys(formData.customData || {})])).length > 0 && (
                                        <div className="space-y-4">
                                            <h4 className="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Extra Fields (Imported)</h4>
                                            <div className="grid grid-cols-1 gap-4">
                                                {Array.from(new Set([...customHeadings, ...Object.keys(formData.customData || {})])).map(h => (<Input key={h} label={h} value={formData.customData?.[h] || ''} onChange={v => setFormData({...formData, customData: {...formData.customData, [h]: v}})} />))}
                                            </div>
                                        </div>
                                    )}
                                    <div className="border-t pt-4">
                                        {!isCameraActive ? (
                                            <button type="button" onClick={openCamera} className="w-full py-8 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center gap-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50/20 transition-all relative overflow-hidden">
                                                {formData.photo ? <img src={formData.photo} className="h-16 rounded-xl mb-2"/> : <Icon name="scan" size={24} />}
                                                <span className="text-[10px] font-black uppercase tracking-widest">{formData.photo ? 'Retake Photo' : 'Scan Cheque / Document'}</span>
                                                {isScanning && <div className="absolute inset-0 bg-blue-50/90 flex flex-col items-center justify-center animate-in fade-in"><div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-2"></div><span className="text-[9px] font-black text-blue-600 uppercase tracking-widest">{scanStatus}</span></div>}
                                            </button>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="relative rounded-3xl overflow-hidden shadow-2xl">
                                                    <video ref={videoRef} autoPlay playsInline className="w-full bg-black aspect-[3/4] object-cover" />
                                                    <div className="scan-line"></div>
                                                    <div className="absolute inset-0 border-2 border-white/50 m-8 rounded-xl pointer-events-none"></div>
                                                    <div className="absolute top-4 left-0 w-full text-center text-white/80 text-[10px] font-black uppercase tracking-widest shadow-sm">Align Document Here</div>
                                                </div>
                                                <canvas ref={canvasRef} className="hidden" />
                                                <div className="flex gap-2">
                                                    <button type="button" onClick={snap} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black uppercase text-xs shadow-lg">Scan & Capture</button>
                                                    <button type="button" onClick={() => { setIsCameraActive(false); if(videoRef.current.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); }} className="px-8 bg-slate-100 rounded-2xl text-xs font-black uppercase text-slate-500">Cancel</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <button type="submit" disabled={isScanning} className="w-full bg-blue-600 text-white py-6 rounded-3xl font-black uppercase tracking-[0.2em] shadow-2xl hover:bg-blue-700 transition-all disabled:bg-slate-300">Save Changes</button>
                                </form>
                            </div>
                        </div>
                    )}
                    {showStatusModal && statusTarget && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 animate-in zoom-in duration-200">
                                <div className="flex justify-between items-center mb-6">
                                    <div><h3 className="font-black text-slate-800 text-lg uppercase tracking-tight">Update Status</h3><p className="text-[10px] font-bold text-slate-400 uppercase">For Case #{statusTarget.serialNo}</p></div>
                                    <button onClick={() => setShowStatusModal(false)} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><Icon name="x" size={18}/></button>
                                </div>
                                {!selectedNewStatus ? (
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Step 1: Select New Status</p>
                                        {statusList.map(st => (
                                            <button key={st} onClick={() => setSelectedNewStatus(st)} className={`w-full p-4 rounded-2xl border font-black text-xs uppercase flex items-center justify-between transition-all hover:bg-slate-50 hover:border-blue-300 ${statusTarget.status === st ? 'border-slate-800 bg-slate-50 opacity-50' : 'bg-white border-slate-100'}`}><span>{st}</span>{statusTarget.status === st && <Icon name="check-circle" size={16}/>}</button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-in slide-in-from-right duration-300">
                                        <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100"><p className="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Changing To</p><h2 className="text-xl font-black text-blue-900 uppercase">{selectedNewStatus}</h2></div>
                                        <div><label className="text-[10px] font-black uppercase text-slate-400 ml-1">Who is changing this status?</label><input type="text" value={updaterName} onChange={(e) => setUpdaterName(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl border font-bold text-sm text-slate-700 outline-none focus:border-blue-500 shadow-inner mt-1" placeholder="Enter Processor Name" autoFocus /></div>
                                        <div className="flex gap-2"><button onClick={confirmStatusUpdate} disabled={!updaterName.trim()} className="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs shadow-xl disabled:opacity-50 disabled:cursor-not-allowed hover:bg-black transition-all">Confirm Update</button><button onClick={() => setSelectedNewStatus(null)} className="px-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-xs hover:bg-slate-200">Back</button></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    {importProgress !== null && (<div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-lg"><div className="bg-white w-full max-sm rounded-[2rem] p-8 text-center space-y-6 animate-in zoom-in duration-300"><div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><div className="text-blue-600 animate-pulse"><Icon name="cloud-upload" size={40}/></div></div><h3 className="font-black text-xl uppercase tracking-tighter">Synchronizing Cloud Data</h3><div className="w-full bg-slate-100 h-4 rounded-full overflow-hidden"><div className="bg-blue-600 h-full transition-all duration-300" style={{ width: `${importProgress}%` }}></div></div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Processing {importProgress}% ... Please wait</p></div></div>)}
                    {showImportModal && (<div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md"><div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl p-10 space-y-6 text-center"><div className="mx-auto text-blue-600 mb-4 inline-block"><Icon name="upload-cloud" size={56} /></div><h3 className="font-black text-2xl uppercase tracking-tighter">Bulk Excel Import</h3><div className="relative border-4 border-dashed rounded-[2.5rem] p-12 hover:bg-slate-50 hover:border-blue-300 cursor-pointer transition-all"><input type="file" accept=".xlsx, .xls" onChange={handleBulkImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><div className="mx-auto text-slate-300 inline-block"><Icon name="file-spreadsheet" size={40} /></div><span className="text-[11px] font-black uppercase mt-4 block text-slate-400 tracking-widest">Upload Excel Data</span></div><button onClick={() => setShowImportModal(false)} className="w-full py-5 bg-slate-800 text-white rounded-2xl font-black uppercase text-xs hover:bg-slate-900 transition-all tracking-widest">Cancel</button></div></div>)}
                    {showReportModal && (<div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md"><div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl p-8 space-y-6"><div className="text-center"><h3 className="font-black text-slate-800 text-xl uppercase tracking-tight">Status Report</h3></div><div className="space-y-4"><div className="flex gap-2"><div className="flex-1 space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-1">From Date</label><input type="date" value={reportFilters.startDate} onChange={e => setReportFilters({...reportFilters, startDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs font-bold" /></div><div className="flex-1 space-y-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-1">To Date</label><input type="date" value={reportFilters.endDate} onChange={e => setReportFilters({...reportFilters, endDate: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs font-bold" /></div></div><select value={reportFilters.bank} onChange={e => setReportFilters({...reportFilters, bank: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border font-bold"><option value="">All Organizations</option>{bankList.map(b => <option key={b} value={b}>{b}</option>)}</select><div className="grid grid-cols-2 gap-2">{statusList.map(s => (<button key={s} onClick={() => toggleReportStatus(s)} className={`p-3 rounded-xl text-[10px] font-black uppercase border transition-all ${reportFilters.status.includes(s) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200'}`}>{s}</button>))}</div></div><div className="pt-4 flex flex-col gap-2"><div className="flex gap-2"><button onClick={() => generateSpecificReport('excel')} className="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-emerald-700 transition-all flex items-center justify-center gap-2"><Icon name="file-spreadsheet" size={16}/> Excel</button><button onClick={() => generateSpecificReport('pdf')} className="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-slate-900 transition-all flex items-center justify-center gap-2"><Icon name="printer" size={16}/> PDF</button></div><button onClick={() => setShowReportModal(false)} className="w-full py-3 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-xs hover:bg-slate-200 transition-all">Close</button></div></div></div>)}
                    {showSettings && (<div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md"><div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl p-10 space-y-12 h-[85vh] overflow-y-auto no-scrollbar"><CategoryManager title="Registered Institutions" list={bankList} onUpdate={(val) => updateSettings('banks', val)} /><CategoryManager title="Lifecycle Stages" list={statusList} onUpdate={(val) => updateSettings('statuses', val)} /><CategoryManager title="Extra Field Headings" list={customHeadings} onUpdate={(val) => updateSettings('headings', val)} /><button onClick={() => setShowSettings(false)} className="w-full py-5 bg-slate-900 text-white rounded-3xl font-black uppercase hover:bg-black transition-all tracking-widest shadow-2xl">Return to System</button></div></div>)}
                </div>
            );
        };

        const DetailCard = ({ label, value, icon }) => (<div className="bg-white p-4 rounded-2xl border border-slate-50 shadow-sm flex items-start gap-3"><div className="p-2.5 bg-slate-50 text-slate-400 rounded-xl shrink-0"><Icon name={icon} size={16} /></div><div className="overflow-hidden"><span className="text-[8px] font-black text-slate-400 uppercase block tracking-widest mb-0.5">{label}</span><p className="font-black text-[11px] text-slate-800 truncate">{value || '-'}</p></div></div>);
        const SidebarLink = ({ active, onClick, icon, label }) => (<button onClick={onClick} className={`w-full flex items-center gap-3 px-5 py-4 rounded-2xl font-black text-sm transition-all ${active ? 'bg-blue-600 text-white shadow-xl' : 'text-slate-400 hover:bg-slate-50'}`}><Icon name={icon} size={18} /> {label}</button>);
        const Input = ({ label, type = "text", ...props }) => (<div className="space-y-1 flex-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">{label}</label><input type={type} {...props} onChange={e => props.onChange(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border font-bold text-sm text-slate-700 shadow-inner focus:ring-2 focus:ring-blue-100 outline-none transition-all" /></div>);
        const Select = ({ label, options, value, onChange }) => (<div className="space-y-1 flex-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">{label}</label><div className="relative"><select value={value} onChange={e => onChange(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl border font-bold text-sm text-slate-700 appearance-none shadow-inner outline-none transition-all focus:ring-2 focus:ring-blue-100">{options.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select><div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><Icon name="chevron-down" size={14} /></div></div></div>);
        const CategoryManager = ({ title, list, onUpdate }) => { const [val, setVal] = useState(''); return (<div className="space-y-4"><h4 className="text-[11px] font-black text-slate-400 uppercase tracking-widest border-l-4 border-blue-600 pl-3">{title}</h4><div className="flex gap-3"><input type="text" className="flex-1 bg-slate-100 p-4 rounded-2xl border-none font-bold text-sm shadow-inner outline-none" placeholder={`Add new...`} value={val} onChange={e => setVal(e.target.value)} /><button onClick={() => {if(val){onUpdate([...list, val]); setVal('')}}} className="bg-blue-600 text-white px-6 rounded-2xl font-black shadow-lg hover:scale-105 active:scale-95 transition-all"><Icon name="plus" /></button></div><div className="flex flex-wrap gap-2">{list.map((item, i) => (<div key={i} className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-slate-100 group shadow-sm transition-all hover:border-red-200"><span className="text-sm font-black text-slate-700">{item}</span><button onClick={() => onUpdate(list.filter((_, idx) => idx !== i))} className="text-slate-300 group-hover:text-red-500 transition-colors"><Icon name="trash-2" size={14}/></button></div>))}</div></div>); };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
